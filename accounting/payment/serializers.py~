from rest_framework.serializers import ModelSerializer

from accounting.models import Payment
from users.models import User, UserAnalysis, UserJobs


class PaymentSerializer(ModelSerializer):
    class Meta:
        model = Payment
        fields = ['id', 'payment_type', 'amount', 'date', 'user']

    def create(self, validated_data):
        print(validated_data)
        user = User.objects.get(validated_data['user'])
        user_jobs = UserJobs.objects.get(user=user)
        payment_sum = 0
        user_analysis = UserAnalysis.objects.filter(user=user, paid=False).all()
        for analysis in user_analysis:
            payment_sum += analysis.analysis.price
            analysis.paid = True
            analysis.save()

        user_jobs.paid = True
        validated_data['amount'] = payment_sum
        return Payment.objects.create(**validated_data)
